# Техническое задание — RieltAr

> Версия: 1.0
> Дата: 16.02.2026

---

## 1. Назначение системы

Веб-приложение для управляющих недвижимостью. Позволяет вести финансовый учёт по каждому собственнику: фиксировать доходы от аренды, расходы, выплаты и отображать текущий баланс.

Собственник получает личный кабинет с прозрачной историей всех операций — как в банковском приложении.

---

## 2. Роли и права доступа

### 2.1 Менеджер (MANAGER)

| Действие | Описание |
|----------|----------|
| Создание собственников | Регистрирует учётную запись собственника (логин + пароль) |
| Управление объектами | CRUD объектов недвижимости, привязка к собственнику |
| Создание заездов | Оформляет заезд гостя с автоматическим созданием операций |
| Добавление операций | Ручное добавление произвольных доходов/расходов |
| Создание выплат | Фиксирует выплату собственнику |
| Просмотр дашбордов | Просмотр финансовой сводки любого собственника |

### 2.2 Собственник (OWNER)

| Действие | Описание |
|----------|----------|
| Просмотр дашборда | Текущий баланс, доход/расход за период, последние операции |
| Просмотр объектов | Список своих объектов недвижимости |
| Просмотр заездов | История заездов с деталями и операциями |
| Просмотр операций | Полная история операций с фильтрацией |
| Просмотр выплат | История полученных выплат |

### 2.3 Ограничения доступа

- Собственник видит **только свои** данные (объекты, операции, выплаты)
- Менеджер видит данные **всех** собственников
- Неавторизованные пользователи не имеют доступа к системе

---

## 3. Сущности и схема данных

### 3.1 User (Пользователь)

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Уникальный идентификатор |
| email | String, unique | Email для входа |
| password | String | Хэш пароля (bcrypt) |
| name | String | Имя пользователя |
| role | Enum: MANAGER / OWNER | Роль в системе |
| createdAt | DateTime | Дата создания |
| updatedAt | DateTime | Дата обновления |

### 3.2 Owner (Собственник)

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Уникальный идентификатор |
| userId | UUID, unique | Связь с User |
| phone | String? | Телефон |
| createdAt | DateTime | Дата создания |
| updatedAt | DateTime | Дата обновления |

**Связи:** User (1:1), Property (1:N), Payout (1:N)

### 3.3 Property (Объект недвижимости)

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Уникальный идентификатор |
| title | String | Название («Квартира на Тверской») |
| address | String | Адрес объекта |
| ownerId | UUID | Связь с Owner |
| createdAt | DateTime | Дата создания |
| updatedAt | DateTime | Дата обновления |

**Связи:** Owner (N:1), Stay (1:N)

### 3.4 Stay (Заезд)

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Уникальный идентификатор |
| propertyId | UUID | Связь с Property |
| guestName | String | Имя гостя |
| checkIn | DateTime | Дата заезда |
| checkOut | DateTime | Дата выезда |
| totalAmount | Decimal(12,2) | Общая сумма бронирования |
| createdAt | DateTime | Дата создания |
| updatedAt | DateTime | Дата обновления |

**Связи:** Property (N:1), Transaction (1:N)

**Бизнес-логика:** При создании заезда автоматически создаются операции:
- `INCOME` — доход от аренды (полная сумма)
- `COMMISSION` — комиссия агрегатора (если указана)
- `CLEANING` — стоимость уборки (если указана)

### 3.5 Transaction (Операция)

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Уникальный идентификатор |
| type | Enum | Тип операции (см. ниже) |
| amount | Decimal(12,2) | Сумма операции (всегда положительная) |
| comment | String? | Комментарий |
| stayId | UUID? | Связь с заездом (опционально) |
| ownerId | UUID | Связь с собственником |
| payoutId | UUID? | Связь с выплатой (опционально) |
| createdAt | DateTime | Дата создания |

**Типы операций (TransactionType):**

| Тип | Направление | Описание |
|-----|-------------|----------|
| INCOME | + | Доход от аренды |
| COMMISSION | − | Комиссия агрегатора (Booking, Airbnb и т.д.) |
| CLEANING | − | Расходы на уборку |
| EXPENSE | − | Прочие расходы |
| PAYOUT | − | Выплата собственнику |

### 3.6 Payout (Выплата)

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Уникальный идентификатор |
| ownerId | UUID | Связь с Owner |
| amount | Decimal(12,2) | Сумма выплаты |
| comment | String? | Комментарий |
| paidAt | DateTime | Дата выплаты |
| createdAt | DateTime | Дата создания |

**Связи:** Owner (N:1), Transaction (1:N)

**Бизнес-логика:** При создании выплаты автоматически создаётся операция с типом `PAYOUT`.

### 3.7 RefreshToken (Токен обновления)

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Уникальный идентификатор |
| tokenHash | String, unique | SHA-256 хэш refresh-токена |
| userId | UUID | Связь с User |
| expiresAt | DateTime | Дата истечения токена |
| createdAt | DateTime | Дата создания |

**Связи:** User (N:1)

**Бизнес-логика:**
- При логине создаётся новый refresh-токен, старые токены пользователя удаляются
- При refresh — ротация: старый токен удаляется, выдаётся новый
- При logout — токен удаляется из БД
- Хранится **хэш** токена, а не сам токен (аналогично паролю)

### 3.8 Диаграмма связей

```
User 1──1 Owner 1──N Property 1──N Stay 1──N Transaction
  │             │                                  │
  │             │                                  │
  └──N RefreshToken   └──N Payout 1────────────N───┘
```

---

## 4. Формула баланса

```
Баланс собственника = Σ(INCOME) − Σ(COMMISSION) − Σ(CLEANING) − Σ(EXPENSE) − Σ(PAYOUT)
```

Баланс **не хранится** в базе — вычисляется динамически из суммы всех операций собственника. Это гарантирует точность и устраняет проблемы рассинхронизации.

---

## 5. API

### 5.1 Авторизация

| Метод | Путь | Доступ | Описание |
|-------|------|--------|----------|
| POST | `/api/auth/login` | Публичный | Вход по email + пароль, возврат access + refresh токенов |
| POST | `/api/auth/refresh` | Публичный | Обновление access-токена по refresh-токену |
| POST | `/api/auth/logout` | Авторизованный | Выход — инвалидация refresh-токена |
| GET | `/api/auth/me` | Авторизованный | Получить текущего пользователя |

### 5.2 Пользователи

| Метод | Путь | Доступ | Описание |
|-------|------|--------|----------|
| POST | `/api/users` | Manager | Создать пользователя-собственника |

### 5.3 Собственники

| Метод | Путь | Доступ | Описание |
|-------|------|--------|----------|
| GET | `/api/owners` | Manager | Список всех собственников |
| GET | `/api/owners/:id` | Manager | Карточка собственника |
| PATCH | `/api/owners/:id` | Manager | Обновить данные собственника |
| DELETE | `/api/owners/:id` | Manager | Удалить собственника |

### 5.4 Объекты недвижимости

| Метод | Путь | Доступ | Описание |
|-------|------|--------|----------|
| POST | `/api/properties` | Manager | Создать объект |
| GET | `/api/properties` | Manager / Owner | Список объектов (Owner — только свои) |
| GET | `/api/properties/:id` | Manager / Owner | Карточка объекта |
| PATCH | `/api/properties/:id` | Manager | Обновить объект |
| DELETE | `/api/properties/:id` | Manager | Удалить объект |

### 5.5 Заезды

| Метод | Путь | Доступ | Описание |
|-------|------|--------|----------|
| POST | `/api/stays` | Manager | Создать заезд (+ авто-транзакции) |
| GET | `/api/stays` | Manager / Owner | Список заездов (с фильтрами) |
| GET | `/api/stays/:id` | Manager / Owner | Детали заезда с операциями |
| PATCH | `/api/stays/:id` | Manager | Обновить заезд |
| DELETE | `/api/stays/:id` | Manager | Удалить заезд |

**Query-параметры для GET `/api/stays`:**
- `propertyId` — фильтр по объекту
- `ownerId` — фильтр по собственнику (Manager)
- `from`, `to` — фильтр по датам

### 5.6 Операции

| Метод | Путь | Доступ | Описание |
|-------|------|--------|----------|
| POST | `/api/transactions` | Manager | Создать операцию |
| GET | `/api/transactions` | Manager / Owner | Список операций (с фильтрами) |
| GET | `/api/transactions/:id` | Manager / Owner | Детали операции |
| DELETE | `/api/transactions/:id` | Manager | Удалить операцию |

**Query-параметры для GET `/api/transactions`:**
- `ownerId` — фильтр по собственнику
- `propertyId` — фильтр по объекту
- `type` — фильтр по типу операции
- `from`, `to` — фильтр по датам

### 5.7 Выплаты

| Метод | Путь | Доступ | Описание |
|-------|------|--------|----------|
| POST | `/api/payouts` | Manager | Создать выплату (+ авто-транзакция PAYOUT) |
| GET | `/api/payouts` | Manager / Owner | Список выплат |
| GET | `/api/payouts/:id` | Manager / Owner | Детали выплаты |
| DELETE | `/api/payouts/:id` | Manager | Удалить выплату |

### 5.8 Дашборд

| Метод | Путь | Доступ | Описание |
|-------|------|--------|----------|
| GET | `/api/dashboard` | Owner | Дашборд текущего собственника |
| GET | `/api/dashboard/owner/:id` | Manager | Дашборд конкретного собственника |

**Ответ дашборда:**

```json
{
  "balance": 45000.00,
  "totalIncome": 120000.00,
  "totalExpenses": 35000.00,
  "totalPayouts": 40000.00,
  "recentTransactions": [...],
  "propertiesCount": 3,
  "activeStaysCount": 1
}
```

---

## 6. Авторизация и безопасность

### 6.1 Аутентификация

- Вход по **email + пароль**
- Пароли хэшируются через **bcrypt** (salt rounds: 10)
- Схема **access + refresh tokens**:

| Токен | Время жизни | Хранение (фронт) | Назначение |
|-------|-------------|-------------------|------------|
| Access | 15 минут | Память (переменная) | Авторизация запросов |
| Refresh | 7 дней | localStorage | Обновление access-токена |

- Access-токен передаётся в заголовке: `Authorization: Bearer <token>`
- Refresh-токен передаётся в теле `POST /api/auth/refresh`
- Refresh-токен хранится в БД в виде **SHA-256 хэша** (аналогично паролю)
- При каждом refresh выполняется **ротация**: старый refresh-токен удаляется, выдаётся новая пара
- При logout refresh-токен удаляется из БД (серверная инвалидация)
- При логине старые refresh-токены пользователя удаляются (один сеанс)

### 6.2 Авторизация

- **RolesGuard** — проверка роли пользователя на уровне эндпоинта
- **OwnershipGuard** — собственник имеет доступ только к своим данным
- Декоратор `@Roles(Role.MANAGER)` — ограничение для менеджеров
- Декоратор `@Public()` — открытый эндпоинт (логин, refresh)

### 6.3 Создание учётных записей

- Менеджер создаёт учётные записи собственников
- Собственник **не может** зарегистрироваться самостоятельно
- Первый менеджер создаётся через seed-скрипт

---

## 7. Интерфейс

### 7.1 Общее

- **UI-библиотека:** Ant Design 5
- **Темы:** светлая (по умолчанию) и тёмная
- **Адаптивность:** десктоп (основной) + базовая мобильная адаптация
- **Язык интерфейса:** русский
- **Принцип:** минимум бухгалтерских терминов, максимум понятности

### 7.2 Кабинет собственника

#### Дашборд
- Карточка текущего баланса (крупным шрифтом)
- Три мини-карточки: доход / расходы / выплачено (за текущий месяц)
- Лента последних 5 операций
- Выбор периода (месяц / квартал / всё время)

#### Мои объекты
- Карточки объектов с адресом
- Переход к заездам конкретного объекта

#### Заезды
- Таблица: гость, даты, объект, сумма
- Фильтр по объекту
- Раскрытие — список операций заезда

#### Операции
- Таблица: дата, тип, описание, сумма (+/−)
- Цветовая маркировка: зелёный (доход), красный (расход), синий (выплата)
- Фильтры: тип, объект, период

#### Выплаты
- Таблица: дата, сумма, комментарий

### 7.3 Кабинет менеджера

#### Собственники
- Таблица: имя, телефон, кол-во объектов, баланс
- Поиск по имени
- Кнопка «Добавить собственника»
- Клик — переход в карточку собственника

#### Карточка собственника
- Дашборд собственника (баланс, доход, расход, выплаты)
- Вкладки: объекты / заезды / операции / выплаты
- Быстрые действия: добавить объект, создать заезд, добавить операцию, выплата

#### Объекты
- Таблица всех объектов
- Фильтр по собственнику
- CRUD с формами

#### Создание заезда
- Выбор объекта
- Имя гостя, даты заезда/выезда
- Сумма бронирования
- Комиссия агрегатора (%)
- Стоимость уборки
- Предпросмотр: какие операции будут созданы

#### Операции
- Полная таблица всех операций
- Фильтры: собственник, объект, тип, период

#### Выплаты
- Выбор собственника
- Ввод суммы + комментарий
- Предпросмотр текущего баланса перед выплатой

---

## 8. Технологический стек

| Компонент | Технология | Версия |
|-----------|-----------|--------|
| Frontend runtime | React | 18+ |
| Frontend bundler | Vite | 5+ |
| Frontend UI | Ant Design | 5+ |
| Frontend state | MobX + mobx-react-lite | 6+ |
| Frontend архитектура | Feature-Sliced Design (FSD) | — |
| Frontend язык | TypeScript | 5+ |
| Backend framework | NestJS | 10+ |
| Backend runtime | Node.js | 18+ |
| ORM | Prisma | 5+ |
| База данных | PostgreSQL | 14+ |
| Авторизация | JWT (jsonwebtoken) | — |
| Хэширование | bcrypt | — |
| Валидация | class-validator + class-transformer | — |

---

## 9. Структура проекта

```
rieltAr/
├── backend/
│   ├── prisma/
│   │   ├── schema.prisma
│   │   ├── migrations/
│   │   └── seed.ts
│   ├── src/
│   │   ├── main.ts
│   │   ├── app.module.ts
│   │   ├── common/
│   │   │   ├── decorators/        # @Roles(), @Public(), @CurrentUser()
│   │   │   ├── guards/            # RolesGuard, JwtAuthGuard
│   │   │   ├── filters/           # HttpExceptionFilter
│   │   │   ├── interceptors/      # TransformInterceptor
│   │   │   └── dto/               # PaginationDto и общие DTO
│   │   ├── auth/
│   │   │   ├── auth.module.ts
│   │   │   ├── auth.controller.ts
│   │   │   ├── auth.service.ts
│   │   │   ├── strategies/        # JwtStrategy
│   │   │   └── dto/               # LoginDto
│   │   ├── users/
│   │   ├── owners/
│   │   ├── properties/
│   │   ├── stays/
│   │   ├── transactions/
│   │   ├── payouts/
│   │   ├── dashboard/
│   │   └── prisma/                # PrismaModule, PrismaService
│   ├── .env
│   ├── .env.example
│   ├── nest-cli.json
│   ├── tsconfig.json
│   └── package.json
│
├── frontend/                       # Архитектура: Feature-Sliced Design (FSD)
│   ├── src/
│   │   ├── main.tsx
│   │   ├── app/                    # [FSD: app] — инициализация, провайдеры, роутинг
│   │   │   ├── App.tsx
│   │   │   ├── providers/          # ThemeProvider, RouterProvider
│   │   │   ├── routes/             # Конфигурация роутов
│   │   │   └── styles/
│   │   │
│   │   ├── pages/                  # [FSD: pages] — страницы (композиции виджетов/фич)
│   │   │   ├── login/
│   │   │   ├── manager/
│   │   │   │   ├── owners-list/
│   │   │   │   ├── owner-detail/
│   │   │   │   ├── properties/
│   │   │   │   ├── create-stay/
│   │   │   │   ├── transactions/
│   │   │   │   └── payouts/
│   │   │   └── owner/
│   │   │       ├── dashboard/
│   │   │       ├── properties/
│   │   │       ├── stays/
│   │   │       ├── transactions/
│   │   │       └── payouts/
│   │   │
│   │   ├── widgets/                # [FSD: widgets] — композитные блоки UI
│   │   │   ├── manager-layout/     # Сайдбар + шапка менеджера
│   │   │   └── owner-layout/       # Сайдбар + шапка собственника
│   │   │
│   │   ├── features/               # [FSD: features] — пользовательские действия
│   │   │   ├── auth/               # model/ (MobX store), ui/ (LoginForm)
│   │   │   ├── create-stay/
│   │   │   ├── create-payout/
│   │   │   └── create-owner/
│   │   │
│   │   ├── entities/               # [FSD: entities] — бизнес-сущности
│   │   │   ├── owner/              # model/ (MobX store), ui/ (OwnerCard)
│   │   │   ├── property/
│   │   │   ├── stay/
│   │   │   ├── transaction/
│   │   │   └── payout/
│   │   │
│   │   └── shared/                 # [FSD: shared] — переиспользуемый код
│   │       ├── api/                # Axios client + generated/ (автогенерация)
│   │       ├── ui/                 # BalanceCard, StatCard, TransactionList
│   │       ├── lib/                # Утилиты (formatCurrency и т.д.)
│   │       ├── config/             # Тема, константы
│   │       └── types/              # Общие типы
│   │
│   ├── .env
│   ├── .env.example
│   ├── vite.config.ts
│   ├── tsconfig.json
│   └── package.json
│
├── .gitignore
├── README.md
├── TECHNICAL_SPEC.md
└── PLAN.md
```

---

## 10. Окружение и деплой

### 10.1 Локальная разработка

- PostgreSQL запущен локально или в Docker
- Backend на порту 8070
- Frontend на порту 3070 (Vite dev server)
- Переменные окружения через `.env` файлы

### 10.2 Продакшен

- Managed PostgreSQL в РФ или PostgreSQL на VPS
- Backend: Node.js процесс (PM2 или Docker)
- Frontend: статическая сборка (Vite build), раздача через Nginx
- Лёгкая смена БД-провайдера через `DATABASE_URL`

### 10.3 Seed-данные

Скрипт `prisma/seed.ts` создаёт:
- Менеджера по умолчанию (email: `admin@rieltar.ru`, пароль: `admin123`)
- Тестового собственника с объектами, заездами и операциями

---

## 11. Нефункциональные требования

- Все суммы хранятся в `Decimal(12,2)` — без потери точности
- Баланс вычисляется динамически — нет рассинхронизации
- Все запросы валидируются через `class-validator`
- Ошибки возвращаются в едином формате `{ statusCode, message, error }`
- Пагинация для списков (page, limit)
- API-ответы оборачиваются в единый формат





