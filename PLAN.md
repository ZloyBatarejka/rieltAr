# План разработки — Balivi

> Дата: 16.02.2026

---

## Обзор фаз

| #   | Фаза                            | Описание                           | Статус |
| --- | ------------------------------- | ---------------------------------- | ------ |
| 1   | Инициализация проекта           | Скелет backend + frontend + БД     | ✅     |
| 2   | Авторизация                     | JWT, guards, логин, роутинг, тесты | ⬜     |
| 3   | CRUD сущностей (Backend)        | Все API-эндпоинты + тесты          | ⬜     |
| 4   | Dashboard + баланс              | Агрегация финансов + тесты         | ⬜     |
| 5   | Кабинет менеджера (Frontend)    | Полный UI менеджера + тесты        | ⬜     |
| 6   | Кабинет собственника (Frontend) | Полный UI собственника + тесты     | ⬜     |
| 7   | Полировка + деплой              | Валидация, seed, Docker            | ⬜     |

---

## Фаза 1: Инициализация проекта

**Цель:** запускаемый скелет приложения — backend отвечает на запросы, frontend показывает страницу, БД подключена.

### Шаги

- [x] **1.1** Создать NestJS backend
  - `nest new backend`
  - Удалить лишнее, настроить `main.ts` (CORS, global prefix `/api`)
  - Создать `PrismaModule` + `PrismaService`

- [x] **1.2** Настроить Prisma
  - `npm install prisma @prisma/client`
  - `npx prisma init`
  - Написать `schema.prisma` со всеми моделями (User, Owner, Property, Stay, Transaction, Payout)
  - `npx prisma migrate dev --name init` — первая миграция

- [x] **1.3** Создать React frontend
  - `npm create vite@latest frontend -- --template react-ts`
  - Установить зависимости: `antd`, `@ant-design/icons`, `axios`, `react-router-dom`
  - Настроить базовую структуру папок

- [x] **1.4** Настроить Ant Design
  - Подключить `ConfigProvider` с темой
  - Реализовать переключатель светлая/тёмная тема
  - Настроить русскую локаль

- [x] **1.5** Настроить окружение
  - `.env` и `.env.example` для backend и frontend
  - `.gitignore` (node_modules, dist, .env, prisma/\*.db)
  - Проверить что оба сервера запускаются

**Результат:** backend на :8070 отдаёт `GET /api/health → { status: "ok" }`, frontend на :3070 показывает заглушку с Ant Design.

---

## Фаза 2: Авторизация

**Цель:** менеджер и собственник могут войти в систему, видят разные интерфейсы.

### Backend

- [x] **2.1** Auth модуль — базовая структура
  - Установить: `@nestjs/jwt`, `@nestjs/passport`, `passport-jwt`, `bcrypt`
  - `AuthModule`, `AuthService`, `AuthController`
  - `POST /api/auth/login` — вход, возврат access + refresh токенов
  - `GET /api/auth/me` — текущий пользователь
  - `JwtStrategy` — валидация access-токена

- [x] **2.2** Refresh-токены
  - Модель `RefreshToken` в Prisma (tokenHash, userId, expiresAt)
  - Миграция БД
  - `POST /api/auth/refresh` — обновление пары токенов (ротация)
  - `POST /api/auth/logout` — удаление refresh-токена из БД
  - При логине: удаление старых refresh-токенов, генерация нового
  - Хэширование refresh-токена (SHA-256) перед сохранением в БД

- [x] **2.3** Guards и декораторы
  - `JwtAuthGuard` — глобальный guard
  - `RolesGuard` — проверка роли
  - `@Roles(Role.MANAGER)` — декоратор
  - `@Public()` — пометка открытых эндпоинтов
  - `@CurrentUser()` — извлечение пользователя из токена

- [x] **2.4** Swagger
  - Подключить `@nestjs/swagger`, настроить `DocumentBuilder`
  - Генерация `swagger.json` в папку `swagger/`
  - Скрипт `npm run swagger:generate`
  - Swagger UI доступен по `/api/docs`

- [x] **2.5** Seed-скрипт
  - `prisma/seed.ts` — создание менеджера по умолчанию
  - Настроить `prisma.seed` в `package.json`

- [x] **2.6** Тесты авторизации (Backend)
  - Jest + supertest
  - `AuthService` — unit-тесты (login, refresh, logout, getMe)
  - `AuthController` — e2e-тесты эндпоинтов (login, refresh, logout, me)
  - `JwtAuthGuard` — тесты: закрытый эндпоинт без токена → 401, с токеном → OK
  - `RolesGuard` — тесты: доступ по роли, отказ при несовпадении
  - `@Public()` — тест: публичный эндпоинт доступен без токена

### Frontend

- [x] **2.7** Автогенерация API-клиента
  - Настроить `swagger-typescript-api` на основе `swagger/swagger.json`
  - Сгенерированный код → `frontend/src/api/generated/`
  - Обёртка `ApiClient` с явными типами → `frontend/src/api/api-client.ts`
  - Скрипт `npm run api:generate` для перегенерации

- [x] **2.8** Авторизация UI
  - `AuthStore` (MobX) — хранение access-токена в памяти, refresh-токена в localStorage
  - Страница логина с формой (Ant Design)
  - `PrivateRoute` — редирект неавторизованных
  - Axios interceptor — автоподстановка `Authorization: Bearer`
  - Axios interceptor — при `401` автоматический refresh и retry запроса
  - Кнопка «Выйти» — вызов `POST /api/auth/logout` + очистка токенов
  - Роутинг: менеджер → `/manager/*`, собственник → `/owner/*`

- [ ] **2.9** Layouts
  - `ManagerLayout` — сайдбар с навигацией менеджера
  - `OwnerLayout` — сайдбар с навигацией собственника

- [ ] **2.10** Тесты авторизации (Frontend)
  - Vitest + React Testing Library
  - `AuthStore` — unit-тесты (login, logout, refresh, состояния)
  - Страница логина — рендер формы, валидация, submit
  - `PrivateRoute` — редирект неавторизованных, пропуск авторизованных

**Результат:** можно залогиниться (access + refresh), автообновление токена, logout, разные layout-ы для менеджера и собственника. Тесты покрывают ключевые сценарии.

---

## Фаза 3: CRUD сущностей (Backend)

**Цель:** все API-эндпоинты работают, данные сохраняются в БД.

### Шаги

- [ ] **3.1** Users модуль
  - `POST /api/users` — менеджер создаёт собственника (User + Owner)
  - DTO с валидацией (email, password, name, phone)
  - Хэширование пароля при создании

- [ ] **3.2** Owners модуль
  - `GET /api/owners` — список с пагинацией + поиск
  - `GET /api/owners/:id` — карточка собственника (с подсчётом баланса)
  - `PATCH /api/owners/:id` — обновление
  - `DELETE /api/owners/:id` — мягкое/жёсткое удаление

- [ ] **3.3** Properties модуль
  - CRUD для объектов недвижимости
  - Фильтрация по `ownerId`
  - Для собственника — автоматический фильтр по своему ID

- [ ] **3.4** Stays модуль
  - `POST /api/stays` — создание заезда
    - Автоматическое создание транзакций: INCOME, COMMISSION (опц.), CLEANING (опц.)
    - Всё в одной Prisma-транзакции (`prisma.$transaction`)
  - `GET /api/stays` — список с фильтрами (propertyId, ownerId, даты)
  - `GET /api/stays/:id` — детали с вложенными транзакциями
  - `DELETE /api/stays/:id` — удаление заезда + связанных транзакций

- [ ] **3.5** Transactions модуль
  - `POST /api/transactions` — ручное добавление операции
  - `GET /api/transactions` — список с фильтрами + пагинация
  - `DELETE /api/transactions/:id` — удаление

- [ ] **3.6** Payouts модуль
  - `POST /api/payouts` — создание выплаты
    - Автоматическое создание транзакции типа PAYOUT
    - В одной Prisma-транзакции
  - `GET /api/payouts` — список выплат
  - `DELETE /api/payouts/:id` — удаление

- [ ] **3.7** Тесты CRUD (Backend)
  - Jest + supertest
  - Users — создание собственника, валидация DTO, дубликат email
  - Owners — CRUD, пагинация, подсчёт баланса
  - Properties — CRUD, фильтрация по ownerId, ограничение доступа собственника
  - Stays — создание с автотранзакциями, каскадное удаление
  - Transactions — CRUD, фильтры, ручное добавление
  - Payouts — создание с автотранзакцией PAYOUT

**Результат:** все CRUD-операции работают через API, покрыты тестами.

---

## Фаза 4: Dashboard + агрегация баланса

**Цель:** эндпоинты для дашборда с расчётом баланса.

### Шаги

- [ ] **4.1** Dashboard модуль
  - `GET /api/dashboard` — для собственника (автоопределение по JWT)
  - `GET /api/dashboard/owner/:id` — для менеджера
  - Агрегация через Prisma `groupBy` / `aggregate`:
    - Общий баланс
    - Доход за период
    - Расходы за период
    - Выплаты за период
    - Последние 5 операций
    - Количество объектов
    - Количество активных заездов

- [ ] **4.2** Фильтрация по периоду
  - Query-параметры: `period` (month / quarter / year / all)
  - Или `from` / `to` для произвольного диапазона

- [ ] **4.3** Тесты Dashboard (Backend)
  - Jest + supertest
  - Корректность расчёта баланса (INCOME − COMMISSION − CLEANING − EXPENSE − PAYOUT)
  - Фильтрация по периоду (month / quarter / year / all / from-to)
  - Доступ: собственник видит только свой дашборд, менеджер — любой
  - Корректность агрегации: propertiesCount, activeStaysCount

**Результат:** API возвращает полную финансовую сводку для дашборда, покрыто тестами.

---

## Фаза 5: Фронтенд — Кабинет менеджера

**Цель:** полностью рабочий UI для менеджера.

### Шаги

- [ ] **5.1** API-клиент
  - Перегенерация `swagger-typescript-api` с новыми эндпоинтами
  - Обновление обёртки `ApiClient`
  - Обработка ошибок (toast-уведомления)

- [ ] **5.2** Список собственников (`/manager/owners`)
  - Таблица: имя, телефон, объектов, баланс
  - Поиск по имени
  - Кнопка «Добавить собственника» → модальное окно с формой

- [ ] **5.3** Карточка собственника (`/manager/owners/:id`)
  - Шапка: имя, баланс, быстрые действия
  - Вкладки (Tabs):
    - Обзор (мини-дашборд)
    - Объекты
    - Заезды
    - Операции
    - Выплаты

- [ ] **5.4** Управление объектами
  - Таблица объектов (в карточке собственника + отдельная страница)
  - Модальная форма: название, адрес, собственник
  - Редактирование, удаление

- [ ] **5.5** Создание заезда (`/manager/stays/create`)
  - Форма: выбор объекта, имя гостя, даты, сумма
  - Поля: комиссия (%), стоимость уборки
  - Предпросмотр создаваемых операций
  - Кнопка «Создать» — один запрос, всё создаётся

- [ ] **5.6** Операции (`/manager/transactions`)
  - Таблица всех операций
  - Фильтры: собственник, объект, тип, период
  - Форма добавления произвольной операции

- [ ] **5.7** Выплаты (`/manager/payouts`)
  - Таблица выплат
  - Форма: выбрать собственника, показать баланс, ввести сумму
  - Подтверждение перед созданием

- [ ] **5.8** Тесты UI менеджера (Frontend)
  - Vitest + React Testing Library
  - Форма создания собственника — валидация, submit, обработка ошибок
  - Форма создания заезда — предпросмотр операций, submit
  - Форма создания выплаты — отображение баланса, подтверждение
  - Таблицы с фильтрами — отображение данных, фильтрация, пагинация

**Результат:** менеджер может полноценно работать через UI, ключевые сценарии покрыты тестами.

---

## Фаза 6: Фронтенд — Кабинет собственника

**Цель:** собственник видит свои финансы как в банковском приложении.

### Шаги

- [ ] **6.1** Дашборд (`/owner/dashboard`)
  - Крупная карточка баланса
  - Три карточки статистики: доход / расходы / выплачено
  - Выбор периода (месяц / квартал / всё время)
  - Лента последних 5 операций (с иконками и цветами)

- [ ] **6.2** Мои объекты (`/owner/properties`)
  - Карточки объектов (Card)
  - Адрес, количество заездов
  - Переход к заездам объекта

- [ ] **6.3** Заезды (`/owner/stays`)
  - Таблица: гость, объект, даты, сумма
  - Фильтр по объекту
  - Раскрытие строки — список операций заезда

- [ ] **6.4** Операции (`/owner/transactions`)
  - Таблица операций с цветовой маркировкой
  - Зелёный — доход, красный — расход, синий — выплата
  - Фильтры: тип, объект, период

- [ ] **6.5** Выплаты (`/owner/payouts`)
  - Таблица: дата, сумма, комментарий

- [ ] **6.6** Тесты UI собственника (Frontend)
  - Vitest + React Testing Library
  - Дашборд — отображение баланса, статистики, смена периода
  - Таблицы — отображение данных, фильтрация
  - Ограничение: собственник видит только свои данные

**Результат:** собственник видит все свои финансы в понятном интерфейсе, ключевые сценарии покрыты тестами.

---

## Фаза 7: Полировка + деплой

**Цель:** production-ready приложение.

### Backend

- [ ] **7.1** Валидация и обработка ошибок (Backend)
  - Валидация всех DTO на бэке (class-validator)
  - Глобальный `HttpExceptionFilter` — единый формат ошибок
  - Логирование ошибок

### Frontend

- [ ] **7.2** Обработка ошибок (Frontend)
  - Валидация всех форм (Ant Design Form rules)
  - Toast-уведомления для ошибок API
  - Обработка сетевых ошибок, таймаутов

### Общее

- [ ] **7.3** Seed-данные
  - Расширить `prisma/seed.ts`:
    - Менеджер
    - 2-3 собственника
    - Объекты с заездами
    - Операции и выплаты
  - Документировать команду `npx prisma db seed`

- [ ] **7.4** Docker
  - `Dockerfile` для backend
  - `Dockerfile` для frontend (nginx + static)
  - `docker-compose.yml` (backend + frontend + postgres)
  - `.dockerignore`

- [ ] **7.5** Деплой
  - Настроить переменные окружения для продакшена
  - Nginx конфигурация (reverse proxy для API)
  - PM2 или Docker на VPS
  - SSL-сертификат (Let's Encrypt)

- [ ] **7.6** Финальная проверка
  - E2E-проверка всех сценариев
  - Проверка ролей и ограничений доступа
  - Проверка корректности расчёта баланса
  - Мобильная адаптация (базовая)

**Результат:** приложение задеплоено и готово к использованию.

---

## Зависимости между фазами

```
Фаза 1 (Инициализация)
  └─→ Фаза 2 (Авторизация)
        ├─→ 2.1–2.6 Backend (auth + guards + swagger + seed + тесты)
        └─→ 2.7–2.10 Frontend (codegen + auth UI + layouts + тесты)
              └─→ Фаза 3 (CRUD Backend + тесты)
                    ├─→ Фаза 4 (Dashboard Backend + тесты)
                    ├─→ Фаза 5 (UI Менеджера + тесты)
                    └─→ Фаза 6 (UI Собственника + тесты)
                          └─→ Фаза 7 (Полировка + Деплой)
```

Фазы 4, 5, 6 можно частично делать параллельно после завершения Фазы 3.

---

## Оценка трудозатрат

| Фаза                                        | Примерно        |
| ------------------------------------------- | --------------- |
| 1. Инициализация                            | 2–3 часа        |
| 2. Авторизация (backend + frontend + тесты) | 5–7 часов       |
| 3. CRUD (Backend) + тесты                   | 7–10 часов      |
| 4. Dashboard + тесты                        | 3–4 часа        |
| 5. UI Менеджера + тесты                     | 10–14 часов     |
| 6. UI Собственника + тесты                  | 6–9 часов       |
| 7. Полировка + Деплой                       | 4–6 часов       |
| **Итого**                                   | **~37–53 часа** |

---

## Как использовать этот план

1. Перед началом каждой фазы — перечитать соответствующий раздел
2. По завершении шага — отметить чекбокс `[x]`
3. При изменении требований — обновить ТЗ (`TECHNICAL_SPEC.md`) и этот план
4. Каждая фаза заканчивается проверяемым результатом
5. Тесты пишутся **в рамках каждой фазы**, а не откладываются на конец
