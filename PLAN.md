# План разработки — RieltAr

> Дата: 16.02.2026

---

## Обзор фаз

| # | Фаза | Описание | Статус |
|---|------|----------|--------|
| 1 | Инициализация проекта | Скелет backend + frontend + БД | ✅ |
| 2 | Авторизация | JWT, guards, логин, роутинг | ⬜ |
| 3 | CRUD сущностей (Backend) | Все API-эндпоинты | ⬜ |
| 4 | Dashboard + баланс | Агрегация финансов | ⬜ |
| 5 | Кабинет менеджера (Frontend) | Полный UI менеджера | ⬜ |
| 6 | Кабинет собственника (Frontend) | Полный UI собственника | ⬜ |
| 7 | Полировка + деплой | Валидация, seed, Docker | ⬜ |

---

## Фаза 1: Инициализация проекта

**Цель:** запускаемый скелет приложения — backend отвечает на запросы, frontend показывает страницу, БД подключена.

### Шаги

- [x] **1.1** Создать NestJS backend
  - `nest new backend`
  - Удалить лишнее, настроить `main.ts` (CORS, global prefix `/api`)
  - Создать `PrismaModule` + `PrismaService`

- [x] **1.2** Настроить Prisma
  - `npm install prisma @prisma/client`
  - `npx prisma init`
  - Написать `schema.prisma` со всеми моделями (User, Owner, Property, Stay, Transaction, Payout)
  - `npx prisma migrate dev --name init` — первая миграция

- [x] **1.3** Создать React frontend
  - `npm create vite@latest frontend -- --template react-ts`
  - Установить зависимости: `antd`, `@ant-design/icons`, `axios`, `react-router-dom`
  - Настроить базовую структуру папок

- [x] **1.4** Настроить Ant Design
  - Подключить `ConfigProvider` с темой
  - Реализовать переключатель светлая/тёмная тема
  - Настроить русскую локаль

- [x] **1.5** Настроить окружение
  - `.env` и `.env.example` для backend и frontend
  - `.gitignore` (node_modules, dist, .env, prisma/*.db)
  - Проверить что оба сервера запускаются

**Результат:** backend на :3000 отдаёт `GET /api/health → { status: "ok" }`, frontend на :5173 показывает заглушку с Ant Design.

---

## Фаза 2: Авторизация

**Цель:** менеджер и собственник могут войти в систему, видят разные интерфейсы.

### Шаги

- [ ] **2.1** Auth модуль (Backend)
  - Установить: `@nestjs/jwt`, `@nestjs/passport`, `passport-jwt`, `bcrypt`
  - `AuthModule`, `AuthService`, `AuthController`
  - `POST /api/auth/login` — вход, возврат JWT
  - `GET /api/auth/me` — текущий пользователь
  - `JwtStrategy` — валидация токена

- [ ] **2.2** Guards и декораторы
  - `JwtAuthGuard` — глобальный guard
  - `RolesGuard` — проверка роли
  - `@Roles(Role.MANAGER)` — декоратор
  - `@Public()` — пометка открытых эндпоинтов
  - `@CurrentUser()` — извлечение пользователя из токена

- [ ] **2.3** Swagger + автогенерация API-клиента
  - Backend: подключить `@nestjs/swagger`, настроить генерацию `swagger.json` в папку `swagger/`
  - Frontend: настроить кодогенератор (orval / openapi-generator) на основе `swagger/swagger.json`
  - Сгенерированный код → `frontend/src/api/generated/`
  - Скрипт `npm run api:generate` для перегенерации

- [ ] **2.4** Seed-скрипт
  - `prisma/seed.ts` — создание менеджера по умолчанию
  - Настроить `prisma.seed` в `package.json`

- [ ] **2.5** Фронтенд: авторизация
  - `AuthContext` — хранение токена и пользователя
  - Страница логина с формой (Ant Design)
  - `PrivateRoute` — редирект неавторизованных
  - Axios interceptor — автоподстановка `Authorization: Bearer`
  - Роутинг: менеджер → `/manager/*`, собственник → `/owner/*`

- [ ] **2.6** Layouts
  - `ManagerLayout` — сайдбар с навигацией менеджера
  - `OwnerLayout` — сайдбар с навигацией собственника

**Результат:** можно залогиниться, увидеть разные layout-ы для менеджера и собственника.

---

## Фаза 3: CRUD сущностей (Backend)

**Цель:** все API-эндпоинты работают, данные сохраняются в БД.

### Шаги

- [ ] **3.1** Users модуль
  - `POST /api/users` — менеджер создаёт собственника (User + Owner)
  - DTO с валидацией (email, password, name, phone)
  - Хэширование пароля при создании

- [ ] **3.2** Owners модуль
  - `GET /api/owners` — список с пагинацией + поиск
  - `GET /api/owners/:id` — карточка собственника (с подсчётом баланса)
  - `PATCH /api/owners/:id` — обновление
  - `DELETE /api/owners/:id` — мягкое/жёсткое удаление

- [ ] **3.3** Properties модуль
  - CRUD для объектов недвижимости
  - Фильтрация по `ownerId`
  - Для собственника — автоматический фильтр по своему ID

- [ ] **3.4** Stays модуль
  - `POST /api/stays` — создание заезда
    - Автоматическое создание транзакций: INCOME, COMMISSION (опц.), CLEANING (опц.)
    - Всё в одной Prisma-транзакции (`prisma.$transaction`)
  - `GET /api/stays` — список с фильтрами (propertyId, ownerId, даты)
  - `GET /api/stays/:id` — детали с вложенными транзакциями
  - `DELETE /api/stays/:id` — удаление заезда + связанных транзакций

- [ ] **3.5** Transactions модуль
  - `POST /api/transactions` — ручное добавление операции
  - `GET /api/transactions` — список с фильтрами + пагинация
  - `DELETE /api/transactions/:id` — удаление

- [ ] **3.6** Payouts модуль
  - `POST /api/payouts` — создание выплаты
    - Автоматическое создание транзакции типа PAYOUT
    - В одной Prisma-транзакции
  - `GET /api/payouts` — список выплат
  - `DELETE /api/payouts/:id` — удаление

**Результат:** все CRUD-операции работают через API, можно тестировать через Postman/curl.

---

## Фаза 4: Dashboard + агрегация баланса

**Цель:** эндпоинты для дашборда с расчётом баланса.

### Шаги

- [ ] **4.1** Dashboard модуль
  - `GET /api/dashboard` — для собственника (автоопределение по JWT)
  - `GET /api/dashboard/owner/:id` — для менеджера
  - Агрегация через Prisma `groupBy` / `aggregate`:
    - Общий баланс
    - Доход за период
    - Расходы за период
    - Выплаты за период
    - Последние 5 операций
    - Количество объектов
    - Количество активных заездов

- [ ] **4.2** Фильтрация по периоду
  - Query-параметры: `period` (month / quarter / year / all)
  - Или `from` / `to` для произвольного диапазона

**Результат:** API возвращает полную финансовую сводку для дашборда.

---

## Фаза 5: Фронтенд — Кабинет менеджера

**Цель:** полностью рабочий UI для менеджера.

### Шаги

- [ ] **5.1** API-клиент
  - Функции-обёртки для всех API-эндпоинтов
  - Типы TypeScript для всех сущностей и DTO
  - Обработка ошибок (toast-уведомления)

- [ ] **5.2** Список собственников (`/manager/owners`)
  - Таблица: имя, телефон, объектов, баланс
  - Поиск по имени
  - Кнопка «Добавить собственника» → модальное окно с формой

- [ ] **5.3** Карточка собственника (`/manager/owners/:id`)
  - Шапка: имя, баланс, быстрые действия
  - Вкладки (Tabs):
    - Обзор (мини-дашборд)
    - Объекты
    - Заезды
    - Операции
    - Выплаты

- [ ] **5.4** Управление объектами
  - Таблица объектов (в карточке собственника + отдельная страница)
  - Модальная форма: название, адрес, собственник
  - Редактирование, удаление

- [ ] **5.5** Создание заезда (`/manager/stays/create`)
  - Форма: выбор объекта, имя гостя, даты, сумма
  - Поля: комиссия (%), стоимость уборки
  - Предпросмотр создаваемых операций
  - Кнопка «Создать» — один запрос, всё создаётся

- [ ] **5.6** Операции (`/manager/transactions`)
  - Таблица всех операций
  - Фильтры: собственник, объект, тип, период
  - Форма добавления произвольной операции

- [ ] **5.7** Выплаты (`/manager/payouts`)
  - Таблица выплат
  - Форма: выбрать собственника, показать баланс, ввести сумму
  - Подтверждение перед созданием

**Результат:** менеджер может полноценно работать через UI.

---

## Фаза 6: Фронтенд — Кабинет собственника

**Цель:** собственник видит свои финансы как в банковском приложении.

### Шаги

- [ ] **6.1** Дашборд (`/owner/dashboard`)
  - Крупная карточка баланса
  - Три карточки статистики: доход / расходы / выплачено
  - Выбор периода (месяц / квартал / всё время)
  - Лента последних 5 операций (с иконками и цветами)

- [ ] **6.2** Мои объекты (`/owner/properties`)
  - Карточки объектов (Card)
  - Адрес, количество заездов
  - Переход к заездам объекта

- [ ] **6.3** Заезды (`/owner/stays`)
  - Таблица: гость, объект, даты, сумма
  - Фильтр по объекту
  - Раскрытие строки — список операций заезда

- [ ] **6.4** Операции (`/owner/transactions`)
  - Таблица операций с цветовой маркировкой
  - Зелёный — доход, красный — расход, синий — выплата
  - Фильтры: тип, объект, период

- [ ] **6.5** Выплаты (`/owner/payouts`)
  - Таблица: дата, сумма, комментарий

**Результат:** собственник видит все свои финансы в понятном интерфейсе.

---

## Фаза 7: Полировка + деплой

**Цель:** production-ready приложение.

### Шаги

- [ ] **7.1** Валидация и обработка ошибок
  - Валидация всех форм на фронте (Ant Design Form rules)
  - Валидация всех DTO на бэке (class-validator)
  - Глобальный `HttpExceptionFilter` — единый формат ошибок
  - Toast-уведомления для ошибок на фронте

- [ ] **7.2** Seed-данные
  - Расширить `prisma/seed.ts`:
    - Менеджер
    - 2-3 собственника
    - Объекты с заездами
    - Операции и выплаты
  - Документировать команду `npx prisma db seed`

- [ ] **7.3** Docker
  - `Dockerfile` для backend
  - `Dockerfile` для frontend (nginx + static)
  - `docker-compose.yml` (backend + frontend + postgres)
  - `.dockerignore`

- [ ] **7.4** Деплой
  - Настроить переменные окружения для продакшена
  - Nginx конфигурация (reverse proxy для API)
  - PM2 или Docker на VPS
  - SSL-сертификат (Let's Encrypt)

- [ ] **7.5** Финальная проверка
  - Тестирование всех сценариев
  - Проверка ролей и ограничений доступа
  - Проверка корректности расчёта баланса
  - Мобильная адаптация (базовая)

**Результат:** приложение задеплоено и готово к использованию.

---

## Зависимости между фазами

```
Фаза 1 (Инициализация)
  └─→ Фаза 2 (Авторизация)
        └─→ Фаза 3 (CRUD Backend)
              ├─→ Фаза 4 (Dashboard Backend)
              ├─→ Фаза 5 (UI Менеджера)
              └─→ Фаза 6 (UI Собственника)
                    └─→ Фаза 7 (Полировка + Деплой)
```

Фазы 4, 5, 6 можно частично делать параллельно после завершения Фазы 3.

---

## Оценка трудозатрат

| Фаза | Примерно |
|------|----------|
| 1. Инициализация | 2–3 часа |
| 2. Авторизация | 3–4 часа |
| 3. CRUD (Backend) | 5–7 часов |
| 4. Dashboard | 2–3 часа |
| 5. UI Менеджера | 8–12 часов |
| 6. UI Собственника | 5–7 часов |
| 7. Полировка + Деплой | 4–6 часов |
| **Итого** | **~30–42 часа** |

---

## Как использовать этот план

1. Перед началом каждой фазы — перечитать соответствующий раздел
2. По завершении шага — отметить чекбокс `[x]`
3. При изменении требований — обновить ТЗ (`TECHNICAL_SPEC.md`) и этот план
4. Каждая фаза заканчивается проверяемым результатом



